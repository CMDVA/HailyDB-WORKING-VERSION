{% extends "base.html" %}

{% block title %}{{ alert.event }} - Alert Detail{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Alert Details
            </h1>
            <div class="btn-group" role="group">
                <a href="{{ url_for('get_alerts') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Alerts
                </a>
                <a href="{{ url_for('get_alert', alert_id=alert.id) }}?format=json" class="btn btn-outline-primary" target="_blank">
                    <i class="fas fa-code me-1"></i>JSON
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Alert Card -->
<div class="row">
    <div class="col-12">
        <div class="card alert-card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <!-- Alert Header -->
                        <div class="d-flex align-items-start mb-3">
                            <div class="severity-badge severity-{{ alert.severity.lower() if alert.severity else 'unknown' }} me-3">
                                {{ alert.severity or 'N/A' }}
                            </div>
                            <div class="flex-grow-1">
                                <h2 class="card-title mb-2">{{ alert.event or 'Unknown Event' }}</h2>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    {{ alert.area_desc or 'Area not specified' }}
                                </p>
                            </div>
                        </div>

                        <!-- Radar-Indicated Data -->
                        {% if alert.radar_indicated %}
                        <div class="radar-indicated mb-4">
                            <h5 class="text-danger mb-3">
                                <i class="fas fa-satellite-dish me-1"></i>Radar-Indicated Measurements
                            </h5>
                            <div class="row">
                                {% if alert.radar_indicated.get('hail_inches') %}
                                <div class="col-md-6">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h4 class="mb-1">{{ "%.2f"|format(alert.radar_indicated.hail_inches) }}"</h4>
                                                    <p class="mb-0">Hail Size</p>
                                                    <small class="text-light">
                                                        {% set hail_size = alert.radar_indicated.hail_inches %}
                                                        {% if hail_size >= 4.5 %}Record Size (4.5"+)
                                                        {% elif hail_size >= 4.0 %}Softball (Extremely Severe)
                                                        {% elif hail_size >= 3.0 %}Large Apple (Very Severe)
                                                        {% elif hail_size >= 2.75 %}Baseball (Severe)
                                                        {% elif hail_size >= 2.5 %}Tennis Ball (Severe)
                                                        {% elif hail_size >= 2.0 %}Egg Size (Significant)
                                                        {% elif hail_size >= 1.75 %}Golf Ball (Significant)
                                                        {% elif hail_size >= 1.5 %}Ping Pong Ball
                                                        {% elif hail_size >= 1.25 %}Half Dollar
                                                        {% elif hail_size >= 1.0 %}Quarter Size
                                                        {% elif hail_size >= 0.88 %}Nickel Size
                                                        {% elif hail_size >= 0.75 %}Penny Size
                                                        {% elif hail_size >= 0.5 %}Peanut Size
                                                        {% else %}Pea Size
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <i class="fas fa-cloud-hail fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% if alert.radar_indicated.get('wind_mph') %}
                                <div class="col-md-6">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h4 class="mb-1">{{ alert.radar_indicated.wind_mph }} mph</h4>
                                                    <p class="mb-0">Wind Speed</p>
                                                    <small>
                                                        {% set wind_speed = alert.radar_indicated.wind_mph %}
                                                        {% if wind_speed >= 90 %}Tornado-level
                                                        {% elif wind_speed >= 80 %}Extreme
                                                        {% elif wind_speed >= 70 %}Significant
                                                        {% elif wind_speed >= 58 %}Severe Criteria
                                                        {% else %}Strong
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <i class="fas fa-wind fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- AI Summary -->
                        {% if alert.ai_summary %}
                        <div class="ai-summary mb-4">
                            <h5 class="text-primary mb-2">
                                <i class="fas fa-robot me-1"></i>AI Summary
                            </h5>
                            <p class="mb-0">{{ alert.ai_summary }}</p>
                        </div>
                        {% endif %}

                        <!-- AI Tags -->
                        {% if alert.ai_tags %}
                        <div class="alert-tags mb-4">
                            <h6 class="text-muted mb-2">Tags</h6>
                            {% for tag in alert.ai_tags %}
                                <span class="badge bg-secondary me-1 mb-1">{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Original Description -->
                        {% if alert.properties and alert.properties.get('description') %}
                        <div class="bg-gray-100 text-gray-900">
                          <main class="max-w-4xl mx-auto p-6 space-y-8">

                            <!-- Alert Summary -->
                            <section>
                              <h2 class="text-2xl font-bold border-b pb-1 text-yellow-600">‚ö†Ô∏è Alert Summary</h2>
                              <p><strong>Event:</strong> {{ alert.event }}</p>
                              <p><strong>Issued By:</strong> {{ alert.properties.get('senderName', 'National Weather Service (NWS)') }}</p>
                              <p><strong>Affected Areas:</strong> {{ alert.area_desc or 'Area not specified' }}</p>
                              <p class="mt-2">{{ alert.properties.description }}</p>
                            </section>

                            <!-- Timing -->
                            <section>
                              <h2 class="text-xl font-semibold border-b pb-1 text-gray-800">üìÖ Timing</h2>
                              <table class="w-full mt-2 text-sm">
                                <tbody>
                                  {% if alert.properties.get('sent') %}
                                  <tr class="border-b"><td class="font-medium w-1/3">Alert Issued:</td><td>{{ alert.properties.sent }}</td></tr>
                                  {% endif %}
                                  {% if alert.effective %}
                                  <tr class="border-b"><td class="font-medium">Effective From:</td><td>{{ alert.effective }}</td></tr>
                                  {% endif %}
                                  {% if alert.expires %}
                                  <tr class="border-b"><td class="font-medium">Warning Expired:</td><td>{{ alert.expires }}</td></tr>
                                  {% endif %}
                                  {% if alert.properties.get('ends') %}
                                  <tr class="border-b"><td class="font-medium">Fully Expires:</td><td>{{ alert.properties.ends }}</td></tr>
                                  {% endif %}
                                </tbody>
                              </table>
                            </section>

                            <!-- Storm Details -->
                            <section>
                              <h2 class="text-xl font-semibold border-b pb-1 text-gray-800">üåÄ Storm Details</h2>
                              <ul class="list-disc list-inside text-sm">
                                {% if alert.event %}
                                <li><strong>Type:</strong> {{ alert.event }}</li>
                                {% endif %}
                                {% if alert.severity %}
                                <li><strong>Severity:</strong> {{ alert.severity }}{% if alert.properties.get('status') == 'Actual' %} (initially){% endif %}</li>
                                {% endif %}
                                {% if alert.properties.get('certainty') %}
                                <li><strong>Certainty:</strong> {{ alert.properties.certainty }}</li>
                                {% endif %}
                                {% if alert.properties.get('status') %}
                                <li><strong>Status:</strong> {{ alert.properties.status }}</li>
                                {% endif %}
                                <li><strong>Hazards Remaining:</strong> Gusty winds, heavy rain possible</li>
                                {% if alert.geometry and alert.geometry.get('coordinates') %}
                                <li><strong>Storm Path Coordinates (Polygon):</strong>
                                  <ul class="list-disc list-inside ml-4 mt-1">
                                    {% set coords = alert.geometry.coordinates[0] %}
                                    <li><strong>NW:</strong> {{ "%.2f"|format(coords[0][1]) }}¬∞N, {{ "%.2f"|format(coords[0][0]) }}¬∞W</li>
                                    <li><strong>NE:</strong> {{ "%.2f"|format(coords[1][1]) }}¬∞N, {{ "%.2f"|format(coords[1][0]) }}¬∞W</li>
                                    <li><strong>SE:</strong> {{ "%.2f"|format(coords[2][1]) }}¬∞N, {{ "%.2f"|format(coords[2][0]) }}¬∞W</li>
                                    <li><strong>SW:</strong> {{ "%.2f"|format(coords[3][1]) }}¬∞N, {{ "%.2f"|format(coords[3][0]) }}¬∞W</li>
                                  </ul>
                                </li>
                                {% endif %}
                              </ul>
                            </section>

                            <!-- Affected Zones -->
                            {% if alert.properties.get('geocode') %}
                            <section>
                              <h2 class="text-xl font-semibold border-b pb-1 text-gray-800">üìç Affected Zones (Official Designations)</h2>
                              <table class="w-full text-sm mt-2">
                                <thead>
                                  <tr><th class="text-left">County</th><th>FIPS Code</th><th>NWS Zone Code</th></tr>
                                </thead>
                                <tbody class="divide-y">
                                  {% if alert.properties.geocode.get('SAME') and alert.properties.geocode.get('UGC') %}
                                    {% set counties = alert.area_desc.split(';') if alert.area_desc else [] %}
                                    {% for i in range(alert.properties.geocode.SAME|length) %}
                                    <tr>
                                      <td>{{ counties[i].strip() if i < counties|length else 'N/A' }}</td>
                                      <td>{{ alert.properties.geocode.SAME[i] }}</td>
                                      <td>{{ alert.properties.geocode.UGC[i] }}</td>
                                    </tr>
                                    {% endfor %}
                                  {% endif %}
                                </tbody>
                              </table>
                            </section>
                            {% endif %}

                            <!-- Technical Metadata -->
                            <section>
                              <h2 class="text-xl font-semibold border-b pb-1 text-gray-800">üì° Technical Information</h2>
                              <ul class="list-none text-xs mt-2 space-y-1">
                                <li><strong>Alert ID:</strong> {{ alert.id }}</li>
                                {% if alert.properties.get('parameters', {}).get('WMOidentifier') %}
                                <li><strong>WMO ID:</strong> {{ alert.properties.parameters.WMOidentifier[0] }}</li>
                                {% endif %}
                                {% if alert.properties.get('parameters', {}).get('VTEC') %}
                                <li><strong>VTEC Code:</strong> {{ alert.properties.parameters.VTEC[0] }}</li>
                                {% endif %}
                                {% if alert.properties.get('parameters', {}).get('AWIPSidentifier') %}
                                <li><strong>AWIPS ID:</strong> {{ alert.properties.parameters.AWIPSidentifier[0] }}</li>
                                {% endif %}
                                <li><strong>Message Type:</strong> {{ alert.properties.get('messageType', 'Update') }} (expiration notice)</li>
                                <li><strong>Distribution Channels:</strong> EAS, NWEM, CMAS (Emergency Alert, Wireless Emergency, etc.)</li>
                                <li><strong>Response Type:</strong> Shelter (initially)</li>
                              </ul>
                            </section>

                            <!-- Resources -->
                            <section>
                              <h2 class="text-xl font-semibold border-b pb-1 text-gray-800">üåê Resources</h2>
                              <ul class="list-disc list-inside text-blue-600 text-sm">
                                <li><a href="http://www.weather.gov" class="underline">Official NWS Site</a></li>
                                {% if alert.properties.get('@id') %}
                                <li><a href="{{ alert.properties['@id'] }}" class="underline">Full Alert JSON</a></li>
                                {% endif %}
                              </ul>
                            </section>

                          </main>
                        </div>
                        {% endif %}

                        <!-- Instructions -->
                        {% if alert.properties and alert.properties.get('instruction') %}
                        <div class="instructions mt-4">
                            <h5 class="text-warning mb-2">
                                <i class="fas fa-exclamation-circle me-1"></i>Instructions
                            </h5>
                            <div class="alert alert-warning">
                                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ alert.properties.instruction }}</pre>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Metadata Sidebar -->
                    <div class="col-md-4">
                        <div class="alert-metadata">
                            <h5 class="text-muted mb-3">Alert Information</h5>
                            
                            <!-- Timing -->
                            <div class="mb-3">
                                <h6 class="text-muted">Timing</h6>
                                {% if alert.effective %}
                                <p class="mb-1">
                                    <small>
                                        <i class="fas fa-play me-1 text-success"></i>
                                        <strong>Effective:</strong> {{ alert.effective.strftime('%B %d, %Y at %I:%M %p UTC') }}
                                    </small>
                                </p>
                                {% endif %}
                                
                                {% if alert.expires %}
                                <p class="mb-1">
                                    <small>
                                        <i class="fas fa-stop me-1 text-danger"></i>
                                        <strong>Expires:</strong> {{ alert.expires.strftime('%B %d, %Y at %I:%M %p UTC') }}
                                    </small>
                                </p>
                                {% endif %}
                                
                                {% if alert.sent %}
                                <p class="mb-1">
                                    <small>
                                        <i class="fas fa-paper-plane me-1 text-info"></i>
                                        <strong>Sent:</strong> {{ alert.sent.strftime('%B %d, %Y at %I:%M %p UTC') }}
                                    </small>
                                </p>
                                {% endif %}

                                {% if alert.duration_minutes %}
                                <p class="mb-1">
                                    <small>
                                        <i class="fas fa-clock me-1 text-muted"></i>
                                        <strong>Duration:</strong> {{ alert.duration_minutes }} minutes
                                    </small>
                                </p>
                                {% endif %}
                            </div>

                            <!-- Status -->
                            <div class="mb-3">
                                <h6 class="text-muted">Status</h6>
                                <p class="mb-1">
                                    <small>
                                        <i class="fas fa-{{ 'check-circle text-success' if alert.is_active else 'times-circle text-muted' }} me-1"></i>
                                        <strong>Active:</strong> {{ 'Yes' if alert.is_active else 'No' }}
                                    </small>
                                </p>
                                <p class="mb-1">
                                    <small>
                                        <i class="fas fa-{{ 'robot text-success' if alert.ai_summary else 'robot text-muted' }} me-1"></i>
                                        <strong>AI Enriched:</strong> {{ 'Yes' if alert.ai_summary else 'No' }}
                                    </small>
                                </p>
                            </div>

                            <!-- System Info -->
                            <div class="mb-3">
                                <h6 class="text-muted">System Info</h6>
                                <p class="mb-1">
                                    <small>
                                        <i class="fas fa-download me-1 text-info"></i>
                                        <strong>Ingested:</strong> {{ alert.ingested_at.strftime('%B %d, %Y at %I:%M %p UTC') if alert.ingested_at }}
                                    </small>
                                </p>
                                <p class="mb-1">
                                    <small>
                                        <i class="fas fa-fingerprint me-1 text-muted"></i>
                                        <strong>Alert ID:</strong> 
                                        <code class="small">{{ alert.id[-12:] if alert.id else 'N/A' }}...</code>
                                    </small>
                                </p>
                            </div>

                            <!-- Actions -->
                            <div class="d-grid gap-2">
                                {% if not alert.ai_summary %}
                                <form method="POST" action="{{ url_for('enrich_alert', alert_id=alert.id) }}">
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="fas fa-robot me-1"></i>Enrich with AI
                                    </button>
                                </form>
                                {% else %}
                                <form method="POST" action="{{ url_for('enrich_alert', alert_id=alert.id) }}">
                                    <button type="submit" class="btn btn-outline-success w-100">
                                        <i class="fas fa-sync-alt me-1"></i>Re-enrich
                                    </button>
                                </form>
                                {% endif %}
                                
                                <a href="{{ url_for('get_alert', alert_id=alert.id) }}?format=json" class="btn btn-outline-primary w-100" target="_blank">
                                    <i class="fas fa-code me-1"></i>View Raw JSON
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Geometry Information -->
{% if alert.geometry %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-map me-1"></i>Geographic Coverage
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-2">Alert Coverage Area (GeoJSON)</p>
                <pre class="bg-light p-3 rounded"><code>{{ alert.geometry | tojson(indent=2) }}</code></pre>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh if alert is still active
{% if alert.is_active %}
setTimeout(function() {
    window.location.reload();
}, 300000); // Refresh every 5 minutes for active alerts
{% endif %}
</script>
{% endblock %}