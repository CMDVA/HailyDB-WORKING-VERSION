{% extends "base.html" %}

{% block title %}Confirmed Warnings - HailyDB{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-check-circle me-2"></i>
                Confirmed Warnings
            </h1>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-success" onclick="generateAISummaries()" id="ai-summary-btn">
                    <i class="fas fa-robot me-1"></i>Generate AI Summaries
                </button>
                <a href="/spc-matches/data?format=json" class="btn btn-outline-secondary" target="_blank">
                    <i class="fas fa-code me-1"></i>JSON API
                </a>
                <button type="button" class="btn btn-outline-primary" onclick="loadMatches()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Stats -->
<div class="row mb-4" id="summary-stats">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-success mb-2">
                    <i class="fas fa-shield-alt fa-2x"></i>
                </div>
                <h5 class="card-title" id="verified-count">-</h5>
                <p class="card-text text-muted small">Verified Alerts</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-info mb-2">
                    <i class="fas fa-link fa-2x"></i>
                </div>
                <h5 class="card-title" id="reports-count">-</h5>
                <p class="card-text text-muted small">SPC Reports Linked</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-warning mb-2">
                    <i class="fas fa-star fa-2x"></i>
                </div>
                <h5 class="card-title" id="high-confidence-count">-</h5>
                <p class="card-text text-muted small">High Confidence</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-primary mb-2">
                    <i class="fas fa-percentage fa-2x"></i>
                </div>
                <h5 class="card-title" id="verification-rate">-</h5>
                <p class="card-text text-muted small">Verification Rate</p>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <!-- Search Bar -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="search-input" class="form-label">
                            <i class="fas fa-search me-1"></i>Search Confirmed Warnings
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" 
                                   placeholder="Search by event type, location, AI summary, or SPC report details..."
                                   onkeypress="handleSearchKeyPress(event)"
                                   oninput="handleSearchInput()">
                            <button class="btn btn-outline-secondary" type="button" id="clear-search-btn" 
                                    onclick="clearSearch()" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                            <button class="btn btn-primary" type="button" onclick="performSearch()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            Search across event types, locations, AI summaries, and SPC report details
                        </div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="row g-3">
                    <div class="col-md-6 col-lg-3">
                        <label for="event-filter" class="form-label">Event Type</label>
                        <select class="form-select" id="event-filter">
                            <option value="">All Events</option>
                            <option value="Tornado Warning">Tornado Warning</option>
                            <option value="Severe Thunderstorm Warning">Severe Thunderstorm Warning</option>
                            <option value="Flash Flood Warning">Flash Flood Warning</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="method-filter" class="form-label">Match Method</label>
                        <select class="form-select" id="method-filter">
                            <option value="">All Methods</option>
                            <option value="fips">FIPS Code</option>
                            <option value="latlon">Lat/Lon</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="confidence-filter" class="form-label">Confidence</label>
                        <select class="form-select" id="confidence-filter">
                            <option value="">All Confidence</option>
                            <option value="high">High (â‰¥0.8)</option>
                            <option value="medium">Medium (0.5-0.8)</option>
                            <option value="low">Low (<0.5)</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="state-filter" class="form-label">State</label>
                        <select class="form-select" id="state-filter">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="time-filter" class="form-label">Time Range</label>
                        <select class="form-select" id="time-filter">
                            <option value="24">Last 24 Hours</option>
                            <option value="168">Last 7 Days</option>
                            <option value="720">Last 30 Days</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-primary w-100" onclick="loadMatches()">
                            <i class="fas fa-search me-1"></i>Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Matches Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Verified Alert Matches
                </h5>
                <small class="text-muted" id="match-count">Loading...</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="matches-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Alert Time</th>
                                <th>Event Type</th>
                                <th>Location</th>
                                <th>Method</th>
                                <th>Confidence</th>
                                <th>Reports</th>
                                <th>AI Summary</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="matches-tbody">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading matches...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
        function loadMatches() {
            const eventFilter = document.getElementById('event-filter').value;
            const methodFilter = document.getElementById('method-filter').value;
            const confidenceFilter = document.getElementById('confidence-filter').value;
            const stateFilter = document.getElementById('state-filter').value;
            const timeFilter = document.getElementById('time-filter').value;
            const searchQuery = document.getElementById('search-input').value.trim();
            
            const params = new URLSearchParams({
                hours: timeFilter,
                event: eventFilter,
                method: methodFilter,
                confidence: confidenceFilter,
                state: stateFilter,
                search: searchQuery
            });
            
            fetch(`/spc-matches/data?${params}`)
                .then(response => response.json())
                .then(data => {
                    updateSummaryStats(data.summary);
                    updateMatchesTable(data.matches);
                    populateStateFilter(data.states);
                })
                .catch(error => {
                    console.error('Error loading matches:', error);
                    document.getElementById('matches-tbody').innerHTML = 
                        '<tr><td colspan="8" class="text-center text-danger">Error loading matches</td></tr>';
                });
        }
        
        // Search functionality
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                performSearch();
            }
        }
        
        function handleSearchInput() {
            const searchInput = document.getElementById('search-input');
            const clearButton = document.getElementById('clear-search-btn');
            
            if (searchInput.value.trim()) {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
            }
        }
        
        function performSearch() {
            loadMatches();
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            const clearButton = document.getElementById('clear-search-btn');
            
            searchInput.value = '';
            clearButton.style.display = 'none';
            searchInput.focus();
            loadMatches();
        }
        
        function updateSummaryStats(summary) {
            document.getElementById('verified-count').textContent = summary.verified_count.toLocaleString();
            document.getElementById('reports-count').textContent = summary.total_reports.toLocaleString();
            document.getElementById('high-confidence-count').textContent = summary.high_confidence_count.toLocaleString();
            document.getElementById('verification-rate').textContent = summary.verification_rate + '%';
        }
        
        function populateStateFilter(states) {
            const stateSelect = document.getElementById('state-filter');
            const currentValue = stateSelect.value;
            
            // Clear existing options except "All States"
            stateSelect.innerHTML = '<option value="">All States</option>';
            
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
            
            stateSelect.value = currentValue;
        }
        
        function updateMatchesTable(matches) {
            const tbody = document.getElementById('matches-tbody');
            const matchCount = document.getElementById('match-count');
            
            // Update match count
            matchCount.textContent = `${matches.length} matches found`;
            
            if (matches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No verified matches found</td></tr>';
                return;
            }
            
            tbody.innerHTML = matches.map(match => {
                const confidenceClass = match.confidence >= 0.8 ? 'bg-success' : 
                                      match.confidence >= 0.5 ? 'bg-warning' : 'bg-danger';
                
                const spcReportsHtml = match.spc_reports && match.spc_reports.length > 0 ? 
                    match.spc_reports.map(report => 
                        `<div class="badge bg-light text-dark mb-1 d-block">
                            <strong>${report.report_type.toUpperCase()}</strong> ${report.time_utc}<br>
                            <small>${report.location}, ${report.county} ${report.state}</small>
                        </div>`
                    ).join('') : '<span class="text-muted">No reports</span>';
                
                return `
                    <tr>
                        <td><small>${formatTimestamp(match.effective)}</small></td>
                        <td><span class="badge bg-danger">${match.event}</span></td>
                        <td><small>${match.area_desc}</small></td>
                        <td><span class="badge bg-secondary">${match.match_method.toUpperCase()}</span></td>
                        <td><span class="badge ${confidenceClass}">${(match.confidence * 100).toFixed(0)}%</span></td>
                        <td>${match.report_count || 0}</td>
                        <td>
                            ${match.spc_ai_summary ? 
                                `<div class="text-muted small" style="max-width: 300px;">${match.spc_ai_summary}</div>` : 
                                '<span class="text-muted">No summary available</span>'
                            }
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="window.location.href='/alerts/${match.id}'" title="View Alert Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${match.spc_reports && match.spc_reports.length > 0 ? 
                                    `<div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" title="View SPC Reports">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            ${match.spc_reports.map(report => 
                                                `<li><a class="dropdown-item" href="/spc/reports/${report.id}">
                                                    <i class="fas fa-file-alt me-1"></i>
                                                    ${report.report_type.toUpperCase()} Report #${report.id}
                                                </a></li>`
                                            ).join('')}
                                        </ul>
                                    </div>` : ''
                                }
                                <button class="btn ${match.spc_ai_summary ? 'btn-outline-success' : 'btn-outline-warning'}" 
                                        onclick="generateSingleAISummary('${match.id}', this)" 
                                        title="${match.spc_ai_summary ? 'Regenerate AI Summary' : 'Generate AI Summary'}">
                                    <i class="fas fa-${match.spc_ai_summary ? 'sync' : 'robot'}"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }
        
        function generateAISummaries() {
            const button = document.getElementById('ai-summary-btn');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
            
            fetch('/internal/spc-generate-summaries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Successfully generated ${data.generated} AI summaries for verified matches`);
                    loadMatches(); // Refresh the table to show new summaries
                } else {
                    alert(`Error generating AI summaries: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error generating AI summaries:', error);
                alert('Error generating AI summaries. Please try again.');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            });
        }
        
        function generateSingleAISummary(alertId) {
            // Find the button for this specific alert
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
            
            fetch(`/internal/spc-generate-summary/${alertId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the AI summary cell in the current row
                    const row = button.closest('tr');
                    const summaryCell = row.querySelector('td:nth-child(6)'); // AI Summary column
                    summaryCell.innerHTML = `<div class="text-muted small" style="max-width: 300px;">${data.summary}</div>`;
                    
                    // Update button to "Regenerate" style
                    button.className = 'btn btn-sm btn-outline-success';
                    button.title = 'Regenerate AI Summary';
                    button.innerHTML = '<i class="fas fa-sync me-1"></i>Regenerate';
                } else {
                    alert(`Error generating AI summary: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error generating AI summary:', error);
                alert('Error generating AI summary. Please try again.');
            })
            .finally(() => {
                button.disabled = false;
                if (button.innerHTML.includes('Generating...')) {
                    button.innerHTML = originalText;
                }
            });
        }
        
        // Load matches on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMatches();
            
            // Initialize search functionality
            const searchInput = document.getElementById('search-input');
            if (searchInput.value.trim()) {
                document.getElementById('clear-search-btn').style.display = 'block';
            }
            
            // Auto-refresh every 60 seconds
            setInterval(loadMatches, 60000);
        });
</script>
{% endblock %}