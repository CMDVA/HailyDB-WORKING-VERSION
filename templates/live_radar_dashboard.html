{% extends "base.html" %}

{% block title %}Live Radar Alerts - HailyDB{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-satellite-dish me-2"></i>
                Live Radar Alerts Feed
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshAlerts()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="enableAutoRefresh()">
                    <i class="fas fa-clock me-1"></i>Auto Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Info Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info border-0 shadow-sm">
            <div class="d-flex align-items-center">
                <i class="fas fa-satellite-dish fa-2x me-3 text-info"></i>
                <div>
                    <h5 class="alert-heading mb-1">Live Radar Alerts Feed</h5>
                    <p class="mb-0">
                        Real-time streaming of NWS Active Alerts enriched with radar-indicated hail sizes and wind speeds. 
                        Focus on hail events (any size) and wind speeds 50 mph and greater for actionable damage assessment.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search & Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search me-1"></i>
                    Search & Filter
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Search -->
                    <div class="col-md-6">
                        <label for="searchFilter" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search by location, event type, or description...">
                    </div>
                    
                    <!-- State -->
                    <div class="col-md-3">
                        <label for="stateFilter" class="form-label">State</label>
                        <input type="text" class="form-control" id="stateFilter" placeholder="TX, OK, etc." list="statesList">
                        <datalist id="statesList">
                            <option value="Alabama - AL">AL</option>
                            <option value="Alaska - AK">AK</option>
                            <option value="Arizona - AZ">AZ</option>
                            <option value="Arkansas - AR">AR</option>
                            <option value="California - CA">CA</option>
                            <option value="Colorado - CO">CO</option>
                            <option value="Connecticut - CT">CT</option>
                            <option value="Delaware - DE">DE</option>
                            <option value="Florida - FL">FL</option>
                            <option value="Georgia - GA">GA</option>
                            <option value="Hawaii - HI">HI</option>
                            <option value="Idaho - ID">ID</option>
                            <option value="Illinois - IL">IL</option>
                            <option value="Indiana - IN">IN</option>
                            <option value="Iowa - IA">IA</option>
                            <option value="Kansas - KS">KS</option>
                            <option value="Kentucky - KY">KY</option>
                            <option value="Louisiana - LA">LA</option>
                            <option value="Maine - ME">ME</option>
                            <option value="Maryland - MD">MD</option>
                            <option value="Massachusetts - MA">MA</option>
                            <option value="Michigan - MI">MI</option>
                            <option value="Minnesota - MN">MN</option>
                            <option value="Mississippi - MS">MS</option>
                            <option value="Missouri - MO">MO</option>
                            <option value="Montana - MT">MT</option>
                            <option value="Nebraska - NE">NE</option>
                            <option value="Nevada - NV">NV</option>
                            <option value="New Hampshire - NH">NH</option>
                            <option value="New Jersey - NJ">NJ</option>
                            <option value="New Mexico - NM">NM</option>
                            <option value="New York - NY">NY</option>
                            <option value="North Carolina - NC">NC</option>
                            <option value="North Dakota - ND">ND</option>
                            <option value="Ohio - OH">OH</option>
                            <option value="Oklahoma - OK">OK</option>
                            <option value="Oregon - OR">OR</option>
                            <option value="Pennsylvania - PA">PA</option>
                            <option value="Rhode Island - RI">RI</option>
                            <option value="South Carolina - SC">SC</option>
                            <option value="South Dakota - SD">SD</option>
                            <option value="Tennessee - TN">TN</option>
                            <option value="Texas - TX">TX</option>
                            <option value="Utah - UT">UT</option>
                            <option value="Vermont - VT">VT</option>
                            <option value="Virginia - VA">VA</option>
                            <option value="Washington - WA">WA</option>
                            <option value="West Virginia - WV">WV</option>
                            <option value="Wisconsin - WI">WI</option>
                            <option value="Wyoming - WY">WY</option>
                        </datalist>
                    </div>
                    
                    <!-- Event Type -->
                    <div class="col-md-3">
                        <label for="eventTypeFilter" class="form-label">Event Type</label>
                        <select class="form-select" id="eventTypeFilter">
                            <option value="">All Events</option>
                            <option value="hail">Hail Events</option>
                            <option value="wind">Wind Events</option>
                            <option value="Severe Thunderstorm Warning">Severe Thunderstorm Warning</option>
                            <option value="Tornado Warning">Tornado Warning</option>
                        </select>
                    </div>
                    
                    <!-- Minimum Hail Size -->
                    <div class="col-md-3">
                        <label for="minHailSize" class="form-label">Minimum Hail Size</label>
                        <select class="form-select" id="minHailSize">
                            <option value="">All Sizes</option>
                            <option value="0.25">0.25" (Pea)</option>
                            <option value="0.5">0.5" (Marble)</option>
                            <option value="0.75">0.75" (Penny)</option>
                            <option value="1.0">1.0" (Quarter)</option>
                            <option value="1.25">1.25" (Half Dollar)</option>
                            <option value="1.5">1.5" (Ping Pong Ball)</option>
                            <option value="1.75">1.75" (Golf Ball)</option>
                            <option value="2.0">2.0" (Egg)</option>
                            <option value="2.5">2.5" (Tennis Ball)</option>
                            <option value="2.75">2.75" (Baseball)</option>
                            <option value="3.0">3.0" (Large Apple)</option>
                            <option value="4.0">4.0" (Softball)</option>
                            <option value="4.5">4.5"+ (Grapefruit/Record)</option>
                        </select>
                    </div>
                    
                    <!-- Minimum Wind Speed -->
                    <div class="col-md-3">
                        <label for="minWindSpeed" class="form-label">Minimum Wind Speed</label>
                        <select class="form-select" id="minWindSpeed">
                            <option value="">All Speeds</option>
                            <option value="50" selected>50+ mph</option>
                            <option value="60">60+ mph</option>
                            <option value="70">70+ mph</option>
                            <option value="80">80+ mph</option>
                            <option value="90">90+ mph</option>
                            <option value="100">100+ mph</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>Search & Filter
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>Clear All
                        </button>
                        <span class="text-muted ms-3" id="lastUpdateTime">Last updated: Never</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Radar Events Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-satellite-dish me-1"></i>
                    Live Radar-Detected Severe Weather Events
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="liveRadarTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Time</th>
                                <th>Event Type</th>
                                <th>Location</th>
                                <th>State</th>
                                <th>Hail Size</th>
                                <th>Wind Speed</th>
                                <th>Severity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="liveRadarTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">Loading live radar alerts...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-hail-alerts">0</h4>
                        <p class="card-text">Hail Alerts</p>
                    </div>
                    <i class="fas fa-cloud-hail fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-wind-alerts">0</h4>
                        <p class="card-text">Wind Alerts</p>
                    </div>
                    <i class="fas fa-wind fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-active-alerts">0</h4>
                        <p class="card-text">Active Alerts</p>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-states-affected">0</h4>
                        <p class="card-text">States Affected</p>
                    </div>
                    <i class="fas fa-map-marked-alt fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hail-badge {
    font-weight: bold;
    color: white;
}
.hail-pea { background-color: #28a745; }
.hail-marble { background-color: #ffc107; color: #000; }
.hail-penny { background-color: #fd7e14; }
.hail-quarter { background-color: #dc3545; }
.hail-large { background-color: #6f42c1; }

.wind-badge {
    font-weight: bold;
    color: white;
}
.wind-moderate { background-color: #17a2b8; }
.wind-significant { background-color: #fd7e14; }
.wind-severe { background-color: #dc3545; }

.severity-badge {
    font-weight: bold;
}
.severity-minor { background-color: #28a745; color: white; }
.severity-moderate { background-color: #ffc107; color: #000; }
.severity-significant { background-color: #fd7e14; color: white; }
.severity-severe { background-color: #dc3545; color: white; }

.btn-view {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}
</style>

<script>
let autoRefreshInterval;
let autoRefreshEnabled = false;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
});

function initializeDashboard() {
    console.log('Dashboard JavaScript loaded successfully');
    loadLiveAlerts();
    console.log('Dashboard initialized successfully');
}

function enableAutoRefresh() {
    if (autoRefreshEnabled) {
        clearInterval(autoRefreshInterval);
        autoRefreshEnabled = false;
        document.querySelector('[onclick="enableAutoRefresh()"]').innerHTML = '<i class="fas fa-clock me-1"></i>Auto Refresh';
    } else {
        autoRefreshInterval = setInterval(loadLiveAlerts, 30000); // Refresh every 30 seconds
        autoRefreshEnabled = true;
        document.querySelector('[onclick="enableAutoRefresh()"]').innerHTML = '<i class="fas fa-pause me-1"></i>Stop Auto';
        loadLiveAlerts();
    }
}

// Update last refresh time
function updateLastRefreshTime() {
    const lastUpdateElement = document.getElementById('lastUpdateTime');
    if (lastUpdateElement) {
        lastUpdateElement.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
    }
}

async function loadLiveAlerts() {
    try {
        console.log('Fetching live radar alerts...');
        const response = await fetch('/api/live-radar-alerts');
        const data = await response.json();
        
        console.log('API Response:', data);
        console.log('Alerts count:', data.alerts ? data.alerts.length : 0);
        
        if (data.error) {
            console.error('API Error:', data.error);
            displayError(data.error);
            return;
        }
        
        console.log('Calling displayAlerts with:', data.alerts || []);
        displayAlerts(data.alerts || []);
        updateStatistics(data.statistics || {});
        updateLastRefreshTime();
        
    } catch (error) {
        console.error('Error loading live alerts:', error);
        displayError('Failed to load live radar alerts');
    }
}

function displayAlerts(alerts) {
    const tbody = document.getElementById('liveRadarTableBody');
    
    if (!alerts || alerts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No live radar alerts currently active.</td></tr>';
        return;
    }
    
    // Filter for alerts with radar data and wind/hail information
    const radarAlerts = alerts.filter(alert => {
        const radarData = alert.radar_data || {};
        return radarData.hail_inches > 0 || radarData.wind_mph >= 50;
    });
    
    if (radarAlerts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No radar-detected wind/hail alerts currently active.</td></tr>';
        return;
    }
    
    tbody.innerHTML = radarAlerts.map(alert => {
        const radarData = alert.radar_data || {};
        const hailSize = radarData.hail_inches || 0;
        const windSpeed = radarData.wind_mph || 0;
        
        const hailDisplay = hailSize > 0 ? 
            `<span class="badge ${getHailSizeClass(hailSize)}">${hailSize}"</span><br><small class="text-muted">${getHailSizeName(hailSize)}</small>` : 
            '<span class="text-muted">None</span>';
            
        const windDisplay = windSpeed > 0 ? 
            `<span class="badge ${getWindSpeedClass(windSpeed)}">${windSpeed} mph</span><br><small class="text-muted">${getWindSeverity(windSpeed)}</small>` : 
            '<span class="text-muted">None</span>';
            
        const severity = getSeverityBadge(hailSize, windSpeed);
        
        const time = alert.effective_time ? new Date(alert.effective_time).toLocaleString() : 'Unknown';
        const location = alert.county_names && alert.county_names.length > 0 ? 
            alert.county_names.join(', ') : (alert.area_desc || 'Unknown');
        const state = alert.affected_states && alert.affected_states.length > 0 ? 
            alert.affected_states[0] : extractState(alert.area_desc || '');
        
        return `
            <tr>
                <td>${time}</td>
                <td><span class="badge bg-primary">${alert.event || 'Severe Thunderstorm Warning'}</span></td>
                <td>${location}</td>
                <td><strong>${state}</strong></td>
                <td>${hailDisplay}</td>
                <td>${windDisplay}</td>
                <td>${severity}</td>
                <td>
                    <button class="btn btn-outline-primary btn-sm btn-view" onclick="viewAlert('${alert.id}')">
                        <i class="fas fa-eye me-1"></i>View
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function getHailSizeClass(size) {
    if (size >= 2.0) return 'hail-large';
    if (size >= 1.0) return 'hail-quarter';
    if (size >= 0.75) return 'hail-penny';
    if (size >= 0.5) return 'hail-marble';
    return 'hail-pea';
}

function getHailSizeName(size) {
    if (size >= 4.0) return 'Softball';
    if (size >= 3.0) return 'Large Apple';
    if (size >= 2.75) return 'Baseball';
    if (size >= 2.5) return 'Tennis Ball';
    if (size >= 2.0) return 'Egg';
    if (size >= 1.75) return 'Golf Ball';
    if (size >= 1.5) return 'Ping Pong Ball';
    if (size >= 1.25) return 'Half Dollar';
    if (size >= 1.0) return 'Quarter';
    if (size >= 0.75) return 'Penny';
    if (size >= 0.5) return 'Marble';
    return 'Pea';
}

function getWindSpeedClass(speed) {
    if (speed >= 80) return 'wind-severe';
    if (speed >= 65) return 'wind-significant';
    return 'wind-moderate';
}

function getWindSeverity(speed) {
    if (speed >= 100) return 'Extreme';
    if (speed >= 80) return 'Severe Criteria';
    if (speed >= 65) return 'Significant';
    if (speed >= 50) return 'Severe Criteria';
    return 'Moderate';
}

function getSeverityBadge(hailSize, windSpeed) {
    if (hailSize >= 2.0 || windSpeed >= 80) {
        return '<span class="badge severity-severe">Severe</span>';
    } else if (hailSize >= 1.0 || windSpeed >= 65) {
        return '<span class="badge severity-significant">Significant</span>';
    } else if (hailSize >= 0.5 || windSpeed >= 50) {
        return '<span class="badge severity-moderate">Moderate</span>';
    }
    return '<span class="badge severity-minor">Minor</span>';
}

function extractState(areaDesc) {
    const stateMatch = areaDesc.match(/\b([A-Z]{2})\b/);
    return stateMatch ? stateMatch[1] : '';
}

function updateStatistics(stats) {
    document.getElementById('total-hail-alerts').textContent = stats.hail_alerts || 0;
    document.getElementById('total-wind-alerts').textContent = stats.wind_alerts || 0;
    document.getElementById('total-active-alerts').textContent = stats.total_alerts || 0;
    document.getElementById('total-states-affected').textContent = stats.states_affected || 0;
}

function displayError(message) {
    const tbody = document.getElementById('liveRadarTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            </td>
        </tr>
    `;
}

function refreshAlerts() {
    loadLiveAlerts();
}

function applyFilters() {
    // For now, just refresh the data
    // In a full implementation, this would apply client-side filtering
    loadLiveAlerts();
}

function clearFilters() {
    document.getElementById('searchFilter').value = '';
    document.getElementById('stateFilter').value = '';
    document.getElementById('eventTypeFilter').value = '';
    document.getElementById('minHailSize').value = '';
    document.getElementById('minWindSpeed').value = '50';
    loadLiveAlerts();
}

function viewAlert(alertId) {
    // Open alert details in same window
    window.location.href = `/alerts/${alertId}`;
}
</script>
{% endblock %}