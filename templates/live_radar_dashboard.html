{% extends "base.html" %}

{% block title %}Live Radar Alerts - HailyDB{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-satellite-dish me-2"></i>
                Live Radar Alerts Feed
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshAlerts()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="enableAutoRefresh()">
                    <i class="fas fa-clock me-1"></i>Auto Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Info Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info border-0 shadow-sm">
            <div class="d-flex align-items-center">
                <i class="fas fa-satellite-dish fa-2x me-3 text-info"></i>
                <div>
                    <h5 class="alert-heading mb-1">Live Radar Alerts Feed</h5>
                    <p class="mb-0">
                        Real-time streaming of NWS Active Alerts enriched with radar-indicated hail sizes and wind speeds. 
                        Focus on hail events (any size) and wind speeds 50 mph and greater for actionable damage assessment.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search & Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search me-1"></i>
                    Search & Filter
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Search -->
                    <div class="col-md-6">
                        <label for="searchFilter" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search by location, event type, or description...">
                    </div>
                    
                    <!-- State -->
                    <div class="col-md-3">
                        <label for="stateFilter" class="form-label">State</label>
                        <input type="text" class="form-control" id="stateFilter" placeholder="TX, OK, etc." list="statesList">
                        <datalist id="statesList">
                            <option value="Alabama - AL">AL</option>
                            <option value="Alaska - AK">AK</option>
                            <option value="Arizona - AZ">AZ</option>
                            <option value="Arkansas - AR">AR</option>
                            <option value="California - CA">CA</option>
                            <option value="Colorado - CO">CO</option>
                            <option value="Connecticut - CT">CT</option>
                            <option value="Delaware - DE">DE</option>
                            <option value="Florida - FL">FL</option>
                            <option value="Georgia - GA">GA</option>
                            <option value="Hawaii - HI">HI</option>
                            <option value="Idaho - ID">ID</option>
                            <option value="Illinois - IL">IL</option>
                            <option value="Indiana - IN">IN</option>
                            <option value="Iowa - IA">IA</option>
                            <option value="Kansas - KS">KS</option>
                            <option value="Kentucky - KY">KY</option>
                            <option value="Louisiana - LA">LA</option>
                            <option value="Maine - ME">ME</option>
                            <option value="Maryland - MD">MD</option>
                            <option value="Massachusetts - MA">MA</option>
                            <option value="Michigan - MI">MI</option>
                            <option value="Minnesota - MN">MN</option>
                            <option value="Mississippi - MS">MS</option>
                            <option value="Missouri - MO">MO</option>
                            <option value="Montana - MT">MT</option>
                            <option value="Nebraska - NE">NE</option>
                            <option value="Nevada - NV">NV</option>
                            <option value="New Hampshire - NH">NH</option>
                            <option value="New Jersey - NJ">NJ</option>
                            <option value="New Mexico - NM">NM</option>
                            <option value="New York - NY">NY</option>
                            <option value="North Carolina - NC">NC</option>
                            <option value="North Dakota - ND">ND</option>
                            <option value="Ohio - OH">OH</option>
                            <option value="Oklahoma - OK">OK</option>
                            <option value="Oregon - OR">OR</option>
                            <option value="Pennsylvania - PA">PA</option>
                            <option value="Rhode Island - RI">RI</option>
                            <option value="South Carolina - SC">SC</option>
                            <option value="South Dakota - SD">SD</option>
                            <option value="Tennessee - TN">TN</option>
                            <option value="Texas - TX">TX</option>
                            <option value="Utah - UT">UT</option>
                            <option value="Vermont - VT">VT</option>
                            <option value="Virginia - VA">VA</option>
                            <option value="Washington - WA">WA</option>
                            <option value="West Virginia - WV">WV</option>
                            <option value="Wisconsin - WI">WI</option>
                            <option value="Wyoming - WY">WY</option>
                        </datalist>
                    </div>
                    
                    <!-- Alert Type Filter Toggles -->
                    <div class="col-12">
                        <label class="form-label fw-bold">Filter by Alert Type:</label>
                        <div class="btn-group w-100" role="group" aria-label="Alert type filter">
                            <input type="radio" class="btn-check" name="alertTypeFilter" id="filterAll" value="all" checked>
                            <label class="btn btn-outline-primary" for="filterAll">
                                <i class="fas fa-list me-1"></i>All Alerts
                            </label>
                            
                            <input type="radio" class="btn-check" name="alertTypeFilter" id="filterHail" value="hail">
                            <label class="btn btn-outline-danger" for="filterHail">
                                <i class="fas fa-circle me-1"></i>Hail Only
                            </label>
                            
                            <input type="radio" class="btn-check" name="alertTypeFilter" id="filterWind" value="wind">
                            <label class="btn btn-outline-warning" for="filterWind">
                                <i class="fas fa-wind me-1"></i>Wind Only
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <span class="text-muted" id="lastUpdateTime">Last updated: Never</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Radar Events Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-satellite-dish me-1"></i>
                    Live Radar-Detected Severe Weather Events
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="liveRadarTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Time</th>
                                <th>Event Type</th>
                                <th>Location</th>
                                <th>State</th>
                                <th>Hail Size</th>
                                <th>Wind Speed</th>
                                <th>Severity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="liveRadarTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">Loading live radar alerts...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-hail-alerts">0</h4>
                        <p class="card-text">Hail Alerts</p>
                    </div>
                    <i class="fas fa-cloud-hail fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-wind-alerts">0</h4>
                        <p class="card-text">Wind Alerts</p>
                    </div>
                    <i class="fas fa-wind fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-active-alerts">0</h4>
                        <p class="card-text">Active Alerts</p>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-states-affected">0</h4>
                        <p class="card-text">States Affected</p>
                    </div>
                    <i class="fas fa-map-marked-alt fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hail-badge {
    font-weight: bold;
    color: white;
}
.hail-pea { background-color: #28a745; }
.hail-marble { background-color: #ffc107; color: #000; }
.hail-penny { background-color: #fd7e14; }
.hail-quarter { background-color: #dc3545; }
.hail-large { background-color: #6f42c1; }

.wind-badge {
    font-weight: bold;
    color: white;
}
.wind-moderate { background-color: #17a2b8; }
.wind-significant { background-color: #fd7e14; }
.wind-severe { background-color: #dc3545; }

.severity-badge {
    font-weight: bold;
}
.severity-minor { background-color: #28a745; color: white; }
.severity-moderate { background-color: #ffc107; color: #000; }
.severity-significant { background-color: #fd7e14; color: white; }
.severity-severe { background-color: #dc3545; color: white; }

.btn-view {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}
</style>

<script>
let autoRefreshInterval;
let autoRefreshEnabled = false;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM CONTENT LOADED ===');
    console.log('Page ready state:', document.readyState);
    initializeDashboard();
});

function initializeDashboard() {
    console.log('=== INITIALIZING DASHBOARD ===');
    console.log('Dashboard JavaScript loaded successfully');
    
    // Check if required elements exist
    const tbody = document.getElementById('liveRadarTableBody');
    const statsElements = {
        hail: document.getElementById('total-hail-alerts'),
        wind: document.getElementById('total-wind-alerts'),
        active: document.getElementById('total-active-alerts'),
        states: document.getElementById('total-states-affected')
    };
    
    console.log('Required elements check:');
    console.log('- Table body:', tbody ? 'FOUND' : 'MISSING');
    console.log('- Hail stats:', statsElements.hail ? 'FOUND' : 'MISSING');
    console.log('- Wind stats:', statsElements.wind ? 'FOUND' : 'MISSING');
    console.log('- Active stats:', statsElements.active ? 'FOUND' : 'MISSING');
    console.log('- States stats:', statsElements.states ? 'FOUND' : 'MISSING');
    
    if (!tbody) {
        console.error('CRITICAL ERROR: Table body element not found!');
        return;
    }
    
    // Add event listeners for toggle buttons
    const toggleButtons = document.querySelectorAll('input[name="alertTypeFilter"]');
    toggleButtons.forEach(button => {
        button.addEventListener('change', function() {
            console.log('Filter changed to:', this.value);
            // Re-display alerts with new filter
            if (window.currentAlerts) {
                displayAlerts(window.currentAlerts);
            }
        });
    });
    
    console.log('Starting initial alert load...');
    
    // Use setTimeout to ensure loadLiveAlerts is defined
    setTimeout(() => {
        console.log('loadLiveAlerts function exists:', typeof loadLiveAlerts);
        try {
            if (typeof loadLiveAlerts === 'function') {
                console.log('Calling loadLiveAlerts...');
                loadLiveAlerts();
            } else {
                console.error('loadLiveAlerts is not a function:', typeof loadLiveAlerts);
            }
        } catch (error) {
            console.error('Error calling loadLiveAlerts:', error);
        }
    }, 100);
    
    // Set up auto-refresh to load alerts every 30 seconds
    window.dashboardInterval = setInterval(loadLiveAlerts, 30000);
    
    console.log('Dashboard initialized successfully');
}

function enableAutoRefresh() {
    if (autoRefreshEnabled) {
        // Stop auto refresh and clear both intervals
        clearInterval(autoRefreshInterval);
        clearInterval(window.dashboardInterval);
        autoRefreshEnabled = false;
        document.querySelector('[onclick="enableAutoRefresh()"]').innerHTML = '<i class="fas fa-clock me-1"></i>Auto Refresh';
    } else {
        // Stop the existing dashboard interval and start fresh auto refresh
        clearInterval(window.dashboardInterval);
        autoRefreshInterval = setInterval(loadLiveAlerts, 30000);
        autoRefreshEnabled = true;
        document.querySelector('[onclick="enableAutoRefresh()"]').innerHTML = '<i class="fas fa-pause me-1"></i>Stop Auto';
        loadLiveAlerts();
    }
}

// Update last refresh time
function updateLastRefreshTime() {
    const lastUpdateElement = document.getElementById('lastUpdateTime');
    if (lastUpdateElement) {
        lastUpdateElement.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
    }
}

async function loadLiveAlerts() {
    try {
        console.log('=== loadLiveAlerts() START ===');
        const response = await fetch('/api/live-radar-alerts');
        console.log('Response status:', response.status, response.statusText);
        
        const data = await response.json();
        console.log('=== API Response received ===');
        console.log('Full data object:', data);
        console.log('data.alerts exists:', !!data.alerts);
        console.log('Alerts count:', data.alerts ? data.alerts.length : 0);
        
        if (data.error) {
            console.error('API Error:', data.error);
            displayError(data.error);
            return;
        }
        
        // Store alerts globally for filter toggling
        window.currentAlerts = data.alerts || [];
        console.log('=== Stored alerts globally ===');
        console.log('window.currentAlerts:', window.currentAlerts);
        
        console.log('=== About to call displayAlerts ===');
        displayAlerts(window.currentAlerts);
        console.log('=== displayAlerts call completed ===');
        
        updateStatistics(data.statistics || {});
        updateLastRefreshTime();
        console.log('=== loadLiveAlerts() COMPLETE ===');
        
    } catch (error) {
        console.error('=== ERROR in loadLiveAlerts ===');
        console.error('Error type:', error.constructor.name);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        displayError('Failed to load live radar alerts: ' + error.message);
    } finally {
        // Always ensure loading spinner is cleared
        updateLastRefreshTime();
        // If no alerts were loaded, show empty state
        if (!window.currentAlerts || window.currentAlerts.length === 0) {
            console.log('No alerts loaded, displaying empty state');
            const tbody = document.getElementById('liveRadarTableBody');
            if (tbody && tbody.innerHTML.includes('Loading live radar alerts')) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No live radar alerts currently active.</td></tr>';
            }
        }
    }
}

function displayAlerts(alerts) {
    try {
        console.log('=== displayAlerts() called ===');
        console.log('Received alerts:', alerts);
        console.log('Alerts type:', typeof alerts);
        console.log('Alerts length:', alerts ? alerts.length : 'N/A');
        
        const tbody = document.getElementById('liveRadarTableBody');
        console.log('Table body element found:', tbody ? 'YES' : 'NO');
        
        if (!tbody) {
            console.error('ERROR: Table body element not found!');
            return;
        }
        
        if (!alerts || alerts.length === 0) {
            console.log('No alerts received, showing empty message');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No live radar alerts currently active.</td></tr>';
            return;
        }
        
        console.log('Processing alerts for display...');
    } catch (error) {
        console.error('=== ERROR in displayAlerts start ===');
        console.error('Error:', error);
        return;
    }
    
    // Get current filter selection
    const selectedFilter = document.querySelector('input[name="alertTypeFilter"]:checked')?.value || 'all';
    
    // Apply filter based on toggle selection
    const filteredAlerts = alerts.filter(alert => {
        // Extract wind and hail data from the correct API response structure
        let hailSize = (alert.radar_data && alert.radar_data.hail_inches) || alert.max_hail_size || 0;
        let windSpeed = (alert.radar_data && alert.radar_data.wind_mph) || alert.max_wind_gust || 0;
        
        // Parse from description if not already available
        if (!hailSize && !windSpeed && alert.description) {
            // Parse wind from description
            const windMatch = alert.description.match(/(\d+)\s*mph/i);
            if (windMatch) {
                windSpeed = parseInt(windMatch[1]);
            }
            
            // Parse hail from description
            const hailMatch = alert.description.match(/(pea|penny|nickel|quarter|half dollar|ping pong|golf ball|tennis ball|baseball|softball)\s*size/i);
            if (hailMatch) {
                const hailSizes = {
                    'pea': 0.25, 'penny': 0.75, 'nickel': 0.88, 'quarter': 1.0, 'half dollar': 1.25, 
                    'ping pong': 1.5, 'golf ball': 1.75, 'tennis ball': 2.5, 'baseball': 2.75, 'softball': 4.0
                };
                hailSize = hailSizes[hailMatch[1].toLowerCase()] || 0;
            }
        }
        
        const hasHail = hailSize > 0;
        const hasWind = windSpeed > 0;
        
        console.log(`Alert ${alert.id}: hail=${hailSize}, wind=${windSpeed}, hasHail=${hasHail}, hasWind=${hasWind}`);
        
        // Apply filter based on toggle selection
        switch(selectedFilter) {
            case 'hail':
                return hasHail;
            case 'wind':
                return hasWind;
            case 'all':
            default:
                return true; // Show all alerts regardless of wind/hail values
        }
    });
    
    console.log(`Filtered results: ${filteredAlerts.length} alerts after applying '${selectedFilter}' filter`);
    
    if (filteredAlerts.length === 0) {
        const message = selectedFilter === 'all' ? 
            'No live radar alerts currently active.' :
            `No ${selectedFilter} alerts currently active.`;
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">${message}</td></tr>`;
        return;
    }
    
    console.log('Building table rows for', filteredAlerts.length, 'alerts...');
    
    tbody.innerHTML = filteredAlerts.map(alert => {
        // Extract wind and hail data from the correct API response structure
        let hailSize = (alert.radar_data && alert.radar_data.hail_inches) || alert.max_hail_size || 0;
        let windSpeed = (alert.radar_data && alert.radar_data.wind_mph) || alert.max_wind_gust || 0;
        
        // Parse from description if not already available
        if (!hailSize && !windSpeed && alert.description) {
            const windMatch = alert.description.match(/(\d+)\s*mph/i);
            if (windMatch) {
                windSpeed = parseInt(windMatch[1]);
            }
            
            const hailMatch = alert.description.match(/(pea|penny|nickel|quarter|half dollar|ping pong|golf ball|tennis ball|baseball|softball)\s*size/i);
            if (hailMatch) {
                const hailSizes = {
                    'pea': 0.25, 'penny': 0.75, 'nickel': 0.88, 'quarter': 1.0, 'half dollar': 1.25,
                    'ping pong': 1.5, 'golf ball': 1.75, 'tennis ball': 2.5, 'baseball': 2.75, 'softball': 4.0
                };
                hailSize = hailSizes[hailMatch[1].toLowerCase()] || 0;
            }
        }
        
        const hailDisplay = hailSize > 0 ? 
            `<span class="badge ${getHailSizeClass(hailSize)}">${hailSize}"</span><br><small class="text-muted">${getHailSizeName(hailSize)}</small>` : 
            '<span class="text-muted">None</span>';
            
        const windDisplay = windSpeed > 0 ? 
            `<span class="badge ${getWindSpeedClass(windSpeed)}">${windSpeed} mph</span><br><small class="text-muted">${getWindSeverity(windSpeed)}</small>` : 
            '<span class="text-muted">None</span>';
            
        const severity = getSeverityBadge(hailSize, windSpeed);
        
        const time = alert.effective_time ? new Date(alert.effective_time).toLocaleString() : 'Unknown';
        const location = alert.county_names && alert.county_names.length > 0 ? 
            alert.county_names.join(', ') : (alert.area_desc || 'Unknown');
        const state = alert.affected_states && alert.affected_states.length > 0 ? 
            alert.affected_states[0] : extractState(alert.area_desc || '');
        
        return `
            <tr>
                <td>${time}</td>
                <td><span class="badge bg-primary">${alert.event || 'Severe Thunderstorm Warning'}</span></td>
                <td>${location}</td>
                <td><strong>${state}</strong></td>
                <td>${hailDisplay}</td>
                <td>${windDisplay}</td>
                <td>${severity}</td>
                <td>
                    <button class="btn btn-outline-primary btn-sm btn-view" onclick="viewAlert('${alert.id}')">
                        <i class="fas fa-eye me-1"></i>View
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function getHailSizeClass(size) {
    if (size >= 2.0) return 'hail-large';
    if (size >= 1.0) return 'hail-quarter';
    if (size >= 0.75) return 'hail-penny';
    if (size >= 0.5) return 'hail-marble';
    return 'hail-pea';
}

function getHailSizeName(size) {
    if (size >= 4.0) return 'Softball';
    if (size >= 3.0) return 'Large Apple';
    if (size >= 2.75) return 'Baseball';
    if (size >= 2.5) return 'Tennis Ball';
    if (size >= 2.0) return 'Egg';
    if (size >= 1.75) return 'Golf Ball';
    if (size >= 1.5) return 'Ping Pong Ball';
    if (size >= 1.25) return 'Half Dollar';
    if (size >= 1.0) return 'Quarter';
    if (size >= 0.75) return 'Penny';
    if (size >= 0.5) return 'Marble';
    return 'Pea';
}

function getWindSpeedClass(speed) {
    if (speed >= 80) return 'wind-severe';
    if (speed >= 65) return 'wind-significant';
    return 'wind-moderate';
}

function getWindSeverity(speed) {
    if (speed >= 100) return 'Extreme';
    if (speed >= 80) return 'Severe Criteria';
    if (speed >= 65) return 'Significant';
    if (speed >= 50) return 'Severe Criteria';
    return 'Moderate';
}

function getSeverityBadge(hailSize, windSpeed) {
    if (hailSize >= 2.0 || windSpeed >= 80) {
        return '<span class="badge severity-severe">Severe</span>';
    } else if (hailSize >= 1.0 || windSpeed >= 65) {
        return '<span class="badge severity-significant">Significant</span>';
    } else if (hailSize >= 0.5 || windSpeed >= 50) {
        return '<span class="badge severity-moderate">Moderate</span>';
    }
    return '<span class="badge severity-minor">Minor</span>';
}

function extractState(areaDesc) {
    const stateMatch = areaDesc.match(/\b([A-Z]{2})\b/);
    return stateMatch ? stateMatch[1] : '';
}

function updateStatistics(stats) {
    console.log('=== updateStatistics() called ===');
    console.log('Stats received:', stats);
    
    const elements = {
        hail: document.getElementById('total-hail-alerts'),
        wind: document.getElementById('total-wind-alerts'),
        active: document.getElementById('total-active-alerts'),
        states: document.getElementById('total-states-affected')
    };
    
    console.log('Statistics elements check:');
    Object.keys(elements).forEach(key => {
        console.log(`- ${key}:`, elements[key] ? 'FOUND' : 'MISSING');
    });
    
    if (elements.hail) elements.hail.textContent = stats.hail_alerts || 0;
    if (elements.wind) elements.wind.textContent = stats.wind_alerts || 0;
    if (elements.active) elements.active.textContent = stats.total_alerts || 0;
    if (elements.states) elements.states.textContent = stats.states_affected || 0;
    
    console.log('Statistics updated successfully');
}

function displayError(message) {
    const tbody = document.getElementById('liveRadarTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-4">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            </td>
        </tr>
    `;
}

function refreshAlerts() {
    loadLiveAlerts();
}

function applyFilters() {
    // For now, just refresh the data
    // In a full implementation, this would apply client-side filtering
    loadLiveAlerts();
}

function clearFilters() {
    document.getElementById('searchFilter').value = '';
    document.getElementById('stateFilter').value = '';
    document.getElementById('eventTypeFilter').value = '';
    document.getElementById('minHailSize').value = '';
    document.getElementById('minWindSpeed').value = '50';
    loadLiveAlerts();
}

// Helper functions for formatting display values
function getHailSizeClass(size) {
    if (size >= 2.0) return 'bg-danger';
    if (size >= 1.0) return 'bg-warning';
    if (size >= 0.5) return 'bg-info';
    return 'bg-secondary';
}

function getHailSizeName(size) {
    if (size >= 4.0) return 'Softball+';
    if (size >= 2.75) return 'Baseball';
    if (size >= 2.5) return 'Tennis Ball';
    if (size >= 1.75) return 'Golf Ball';
    if (size >= 1.5) return 'Ping Pong';
    if (size >= 1.25) return 'Half Dollar';
    if (size >= 1.0) return 'Quarter';
    if (size >= 0.88) return 'Nickel';
    if (size >= 0.75) return 'Penny';
    if (size >= 0.5) return 'Marble';
    if (size >= 0.25) return 'Pea';
    return 'Small';
}

function getWindSpeedClass(speed) {
    if (speed >= 75) return 'bg-danger';
    if (speed >= 65) return 'bg-warning';
    if (speed >= 50) return 'bg-info';
    return 'bg-secondary';
}

function getWindSeverity(speed) {
    if (speed >= 75) return 'Extreme';
    if (speed >= 65) return 'Severe';
    if (speed >= 50) return 'Strong';
    return 'Moderate';
}

function getSeverityBadge(hailSize, windSpeed) {
    const maxSeverity = Math.max(
        hailSize >= 2.0 ? 3 : hailSize >= 1.0 ? 2 : hailSize >= 0.5 ? 1 : 0,
        windSpeed >= 75 ? 3 : windSpeed >= 65 ? 2 : windSpeed >= 50 ? 1 : 0
    );
    
    switch(maxSeverity) {
        case 3: return '<span class="badge bg-danger">Extreme</span>';
        case 2: return '<span class="badge bg-warning">Severe</span>';
        case 1: return '<span class="badge bg-info">Moderate</span>';
        default: return '<span class="badge bg-secondary">Light</span>';
    }
}

function extractState(areaDesc) {
    const match = areaDesc.match(/,\s*([A-Z]{2})\b/);
    return match ? match[1] : '';
}

function viewAlert(alertId) {
    // Open alert details in same window
    window.location.href = `/alerts/${alertId}`;
}

// Global error handler
window.addEventListener('error', function(e) {
    console.error('=== JAVASCRIPT ERROR ===');
    console.error('Message:', e.message);
    console.error('Filename:', e.filename);
    console.error('Line:', e.lineno);
    console.error('Column:', e.colno);
    console.error('Error object:', e.error);
    
    const tbody = document.getElementById('liveRadarTableBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        JavaScript Error: ${e.message}
                    </div>
                </td>
            </tr>
        `;
    }
});

// Global unhandled promise rejection handler
window.addEventListener('unhandledrejection', function(e) {
    console.error('=== UNHANDLED PROMISE REJECTION ===');
    console.error('Reason:', e.reason);
    console.error('Promise:', e.promise);
    
    const tbody = document.getElementById('liveRadarTableBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Promise Rejection: ${e.reason}
                    </div>
                </td>
            </tr>
        `;
    }
});
</script>
{% endblock %}