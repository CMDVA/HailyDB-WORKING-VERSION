{% extends "base.html" %}

{% block title %}Radar-Detected Alerts - HailyDB{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-satellite-dish me-2"></i>
                Radar-Detected Severe Weather
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshAlerts()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="exportData()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Info Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info border-0 shadow-sm">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
                <div>
                    <h5 class="alert-heading mb-1">Real-Time Radar Analysis</h5>
                    <p class="mb-0">
                        Display severe weather alerts with confirmed radar-indicated hail sizes and wind speeds. 
                        This data provides actionable intelligence for insurance adjusters, restoration contractors, 
                        and emergency management teams requiring precise damage assessment capabilities.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search me-1"></i>Search & Filter
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="searchQuery" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchQuery" placeholder="Search by location, event type, or description...">
                    </div>
                    <div class="col-md-3">
                        <label for="stateFilter" class="form-label">State</label>
                        <input type="text" class="form-control" id="stateFilter" placeholder="TX, OK, etc.">
                    </div>
                    <div class="col-md-3">
                        <label for="eventFilter" class="form-label">Event Type</label>
                        <select class="form-select" id="eventFilter">
                            <option value="">All Events</option>
                            <option value="Severe Thunderstorm Warning">Severe Thunderstorm Warning</option>
                            <option value="Tornado Warning">Tornado Warning</option>
                            <option value="Severe Weather Statement">Severe Weather Statement</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label for="minHailSize" class="form-label">Minimum Hail Size</label>
                        <select class="form-select" id="minHailSize">
                            <option value="">All Sizes</option>
                            <option value="0.75">0.75" (Penny)</option>
                            <option value="1.0">1.0" (Quarter)</option>
                            <option value="1.25">1.25" (Half Dollar)</option>
                            <option value="1.5">1.5" (Ping Pong)</option>
                            <option value="1.75">1.75" (Golf Ball)</option>
                            <option value="2.0">2.0"+ (Softball)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="minWindSpeed" class="form-label">Minimum Wind Speed</label>
                        <select class="form-select" id="minWindSpeed">
                            <option value="">All Speeds</option>
                            <option value="50">50+ mph</option>
                            <option value="60">60+ mph</option>
                            <option value="70">70+ mph</option>
                            <option value="80">80+ mph</option>
                            <option value="90">90+ mph</option>
                            <option value="100">100+ mph</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>Search & Filter
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-hail-alerts">0</h4>
                        <p class="card-text">Hail Alerts</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-cloud-hail fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-wind-alerts">0</h4>
                        <p class="card-text">Wind Alerts</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-wind fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="max-hail-size">0.0"</h4>
                        <p class="card-text">Max Hail Size</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-ruler fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="max-wind-speed">0 mph</h4>
                        <p class="card-text">Max Wind Speed</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tachometer-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-1"></i>
                    Radar-Indicated Severe Weather Events
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="radarAlertsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Time</th>
                                <th>Event Type</th>
                                <th>Location</th>
                                <th>State</th>
                                <th>Hail Size</th>
                                <th>Wind Speed</th>
                                <th>Severity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="radarAlertsTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">Loading radar-detected alerts...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="row mt-3">
    <div class="col-12">
        <nav id="paginationContainer" style="display: none;">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be dynamically generated -->
            </ul>
        </nav>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};

document.addEventListener('DOMContentLoaded', function() {
    loadRadarAlerts();
    
    // Add enter key support for search
    document.getElementById('searchQuery').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });
    
    // Set default date range to include all radar data (June 2-7, 2025)
    const endDate = new Date('2025-06-07');
    const startDate = new Date('2025-06-02');
    
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    
    // Apply default filters
    applyFilters();
});

function loadRadarAlerts(page = 1) {
    currentPage = page;
    
    // Build query parameters for radar alerts summary API
    const params = new URLSearchParams({
        page: page,
        limit: 25
    });
    
    // Add date filters
    if (currentFilters.effective_start) {
        const startDate = new Date(currentFilters.effective_start);
        params.append('start_date', startDate.toISOString().split('T')[0]);
    }
    if (currentFilters.effective_end) {
        const endDate = new Date(currentFilters.effective_end);
        params.append('end_date', endDate.toISOString().split('T')[0]);
    }
    
    // Add other filters
    if (currentFilters.state) params.append('state', currentFilters.state);
    if (currentFilters.min_hail) params.append('min_hail_inches', currentFilters.min_hail);
    if (currentFilters.min_wind) params.append('min_wind_mph', currentFilters.min_wind);
    if (currentFilters.search) params.append('city', currentFilters.search);
    
    // Show loading state
    document.getElementById('radarAlertsTableBody').innerHTML = 
        '<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 mb-0 text-muted">Loading radar-detected alerts...</p></td></tr>';
    
    fetch(`/api/radar-alerts/list?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            const radarEvents = data.alerts || [];
            updateRadarStatistics(radarEvents);
            updateRadarAlertsTable(radarEvents);
            updateRadarPagination(data.pagination, page);
        })
        .catch(error => {
            console.error('Error loading radar alerts:', error);
            document.getElementById('radarAlertsTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger py-4">Error loading radar alerts. Please try again.</td></tr>';
        });
}

function updateRadarStatistics(radarEvents) {
    let hailAlerts = 0;
    let windAlerts = 0;
    let maxHail = 0;
    let maxWind = 0;
    
    radarEvents.forEach(event => {
        if (event.event_type === 'hail') {
            hailAlerts++;
            const hailSize = event.hail_inches ? parseFloat(event.hail_inches) : 0;
            if (hailSize > maxHail) {
                maxHail = hailSize;
            }
        }
        if (event.event_type === 'wind' || event.wind_mph) {
            windAlerts++;
            const windSpeed = event.wind_mph ? parseInt(event.wind_mph) : 0;
            if (windSpeed > maxWind) {
                maxWind = windSpeed;
            }
        }
    });
    
    document.getElementById('total-hail-alerts').textContent = hailAlerts;
    document.getElementById('total-wind-alerts').textContent = windAlerts;
    document.getElementById('max-hail-size').textContent = maxHail.toFixed(2) + '"';
    document.getElementById('max-wind-speed').textContent = maxWind + ' mph';
}

function updateRadarAlertsTable(radarEvents) {
    const tbody = document.getElementById('radarAlertsTableBody');
    
    if (radarEvents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No radar-detected alerts found for the current filters.</td></tr>';
        return;
    }
    
    tbody.innerHTML = radarEvents.map(event => {
        // Handle individual radar alert data
        const hailSize = event.hail_inches ? parseFloat(event.hail_inches) : 0;
        const windSpeed = event.wind_mph ? parseInt(event.wind_mph) : 0;
        const cityNames = Array.isArray(event.city_names) ? event.city_names.join(', ') : (event.city_names || 'Unknown');
        const states = Array.isArray(event.affected_states) && event.affected_states.length > 0 ? 
            event.affected_states.join(', ') : 'Unknown';
        const eventDate = event.event_date ? new Date(event.event_date).toLocaleDateString() : 'Unknown Date';
        const detectedTime = event.detected_time ? new Date(event.detected_time).toLocaleTimeString() : 'Unknown Time';
        
        const hailDisplay = event.event_type === 'hail' && hailSize > 0 ? 
            `<span class="badge bg-danger">${hailSize.toFixed(2)}"</span>` :
            '<span class="text-muted">-</span>';
            
        const windDisplay = event.event_type === 'wind' && windSpeed > 0 ? 
            `<span class="badge bg-warning text-dark">${windSpeed} mph</span>` :
            (windSpeed > 0 ? `<span class="badge bg-warning text-dark">${windSpeed} mph</span>` : '<span class="text-muted">-</span>');
        
        const severityBadge = getSeverityBadge(hailSize, windSpeed);
        
        return `
            <tr style="cursor: pointer;">
                <td>
                    <div>${detectedTime}</div>
                    <small class="text-muted">${eventDate}</small>
                </td>
                <td>
                    <span class="badge bg-${event.event_type === 'hail' ? 'danger' : 'warning'}">${event.event_type.toUpperCase()}</span>
                </td>
                <td>
                    <strong>${cityNames}</strong><br>
                    <small class="text-muted">${states}</small>
                </td>
                <td>
                    <span class="badge bg-primary">${states}</span>
                </td>
                <td>${hailDisplay}</td>
                <td>${windDisplay}</td>
                <td>${severityBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showEventDetails('${event.alert_id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Add hover effects for clickable rows
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .clickable-row:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
        }
        .clickable-row {
            transition: all 0.2s ease-in-out;
        }
    `;
    document.head.appendChild(style);
});

function formatLocationInfo(alert) {
    const parts = [];
    
    // Extract cities from city_names array
    if (alert.city_names && Array.isArray(alert.city_names) && alert.city_names.length > 0) {
        const cities = alert.city_names.slice(0, 3); // Show first 3 cities
        parts.push(cities.join(', '));
        if (alert.city_names.length > 3) {
            parts.push(`+${alert.city_names.length - 3} more`);
        }
        return parts.join(' ');
    }
    
    // Fallback to county names if no cities
    if (alert.county_names) {
        let counties = [];
        
        // Handle county_names as an object with state keys
        if (typeof alert.county_names === 'object' && !Array.isArray(alert.county_names)) {
            for (const [state, countyList] of Object.entries(alert.county_names)) {
                if (Array.isArray(countyList)) {
                    counties = counties.concat(countyList);
                }
            }
        } else if (Array.isArray(alert.county_names)) {
            counties = alert.county_names;
        }
        
        if (counties.length > 0) {
            const displayCounties = counties.slice(0, 3);
            parts.push(displayCounties.join(', '));
            if (counties.length > 3) {
                parts.push(`+${counties.length - 3} more`);
            }
            return parts.join(' ');
        }
    }
    
    // Final fallback to area description
    if (alert.areaDesc) {
        const shortArea = alert.areaDesc.length > 50 ? 
            alert.areaDesc.substring(0, 50) + '...' : alert.areaDesc;
        return shortArea;
    }
    
    return 'Location data unavailable';
}

function formatStateInfo(alert) {
    // Try to get states from affected_states first
    if (alert.affected_states && Array.isArray(alert.affected_states) && alert.affected_states.length > 0) {
        return alert.affected_states.join(', ');
    }
    
    // Fallback to extracting states from county_names object keys
    if (alert.county_names && typeof alert.county_names === 'object' && !Array.isArray(alert.county_names)) {
        const states = Object.keys(alert.county_names);
        if (states.length > 0) {
            return states.join(', ');
        }
    }
    
    // Final fallback to geocode UGC parsing
    if (alert.geocode && alert.geocode.UGC && Array.isArray(alert.geocode.UGC)) {
        const states = new Set();
        alert.geocode.UGC.forEach(ugc => {
            if (ugc.includes('C')) {
                const parts = ugc.split('C');
                if (parts.length === 2) {
                    states.add(parts[0]);
                }
            }
        });
        if (states.size > 0) {
            return Array.from(states).join(', ');
        }
    }
    
    return 'N/A';
}

function getHailDescription(size) {
    if (size >= 2.0) return 'Softball+';
    if (size >= 1.75) return 'Golf Ball';
    if (size >= 1.5) return 'Ping Pong';
    if (size >= 1.25) return 'Half Dollar';
    if (size >= 1.0) return 'Quarter';
    if (size >= 0.75) return 'Penny';
    return 'Small';
}

function getWindDescription(speed) {
    if (speed >= 90) return 'Tornado-level';
    if (speed >= 80) return 'Extreme';
    if (speed >= 70) return 'Significant';
    if (speed >= 58) return 'Severe Criteria';
    return 'Strong';
}

function getSeverityBadge(hailSize, windSpeed) {
    let severity = 'moderate';
    let label = 'Moderate';
    
    if (hailSize >= 2.0 || windSpeed >= 90) {
        severity = 'extreme';
        label = 'Extreme';
    } else if (hailSize >= 1.5 || windSpeed >= 80) {
        severity = 'severe';
        label = 'Severe';
    } else if (hailSize >= 1.0 || windSpeed >= 70) {
        severity = 'moderate';
        label = 'Moderate';
    } else {
        severity = 'minor';
        label = 'Minor';
    }
    
    const badgeClass = severity === 'extreme' ? 'bg-danger' : 
                      severity === 'severe' ? 'bg-warning text-dark' : 
                      severity === 'moderate' ? 'bg-info' : 'bg-secondary';
    
    return `<span class="badge ${badgeClass}">${label}</span>`;
}

function updateRadarPagination(radarEvents, page) {
    const container = document.getElementById('paginationContainer');
    const pagination = document.getElementById('pagination');
    
    // Simple pagination - hide if less than 25 events
    if (radarEvents.length < 25) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${page === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadRadarAlerts(${page - 1}); return false;">Previous</a>
        </li>
    `;
    
    // Current page
    paginationHTML += `
        <li class="page-item active">
            <a class="page-link" href="#" onclick="loadRadarAlerts(${page}); return false;">${page}</a>
        </li>
    `;
    
    // Next button
    paginationHTML += `
        <li class="page-item">
            <a class="page-link" href="#" onclick="loadRadarAlerts(${page + 1}); return false;">Next</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHTML;
}

function showEventDetails(city, state, date) {
    alert(`Radar Event Details:\nLocation: ${city}, ${state}\nDate: ${date}\n\nDetailed analysis coming soon!`);
}

function applyFilters() {
    currentFilters = {};
    
    const searchQuery = document.getElementById('searchQuery').value.trim();
    const minHail = document.getElementById('minHailSize').value;
    const minWind = document.getElementById('minWindSpeed').value;
    const state = document.getElementById('stateFilter').value.trim();
    const eventFilter = document.getElementById('eventFilter').value.trim();
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (searchQuery) currentFilters.search = searchQuery;
    if (minHail) currentFilters.min_hail = minHail;
    if (minWind) currentFilters.min_wind = minWind;
    if (state) currentFilters.state = state;
    if (eventFilter) currentFilters.event_type = eventFilter;
    
    // Handle date filters
    if (startDate) {
        const startDateTime = new Date(startDate);
        currentFilters.effective_start = startDateTime.toISOString();
    }
    if (endDate) {
        const endDateTime = new Date(endDate);
        endDateTime.setHours(23, 59, 59, 999); // Set to end of day
        currentFilters.effective_end = endDateTime.toISOString();
    }
    
    loadRadarAlerts(1);
}

function clearFilters() {
    document.getElementById('searchQuery').value = '';
    document.getElementById('minHailSize').value = '';
    document.getElementById('minWindSpeed').value = '';
    document.getElementById('stateFilter').value = '';
    document.getElementById('eventFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    currentFilters = {};
    loadRadarAlerts(1);
}

function refreshAlerts() {
    loadRadarAlerts(currentPage);
}

function exportData() {
    const params = new URLSearchParams({
        has_radar_data: 'true',
        limit: 1000,
        format: 'csv'
    });
    
    Object.entries(currentFilters).forEach(([key, value]) => {
        if (value) params.append(key, value);
    });
    
    window.open(`/alerts/search?${params.toString()}`, '_blank');
}
</script>
{% endblock %}