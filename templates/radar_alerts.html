{% extends "base.html" %}

{% block title %}Radar-Detected Alerts - HailyDB{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-satellite-dish me-2"></i>
                Radar-Detected Severe Weather
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshAlerts()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="exportData()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Info Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info border-0 shadow-sm">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
                <div>
                    <h5 class="alert-heading mb-1">Real-Time Radar Analysis</h5>
                    <p class="mb-0">
                        Display severe weather alerts with confirmed radar-indicated hail sizes and wind speeds. 
                        This data provides actionable intelligence for insurance adjusters, restoration contractors, 
                        and emergency management teams requiring precise damage assessment capabilities.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search & Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search me-1"></i>
                    Search & Filter
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Search -->
                    <div class="col-md-6">
                        <label for="searchFilter" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search by location, event type, or description...">
                    </div>
                    
                    <!-- State -->
                    <div class="col-md-3">
                        <label for="stateFilter" class="form-label">State</label>
                        <input type="text" class="form-control" id="stateFilter" placeholder="TX, OK, etc." list="statesList">
                        <datalist id="statesList">
                            <option value="Alabama - AL">AL</option>
                            <option value="Alaska - AK">AK</option>
                            <option value="Arizona - AZ">AZ</option>
                            <option value="Arkansas - AR">AR</option>
                            <option value="California - CA">CA</option>
                            <option value="Colorado - CO">CO</option>
                            <option value="Connecticut - CT">CT</option>
                            <option value="Delaware - DE">DE</option>
                            <option value="Florida - FL">FL</option>
                            <option value="Georgia - GA">GA</option>
                            <option value="Hawaii - HI">HI</option>
                            <option value="Idaho - ID">ID</option>
                            <option value="Illinois - IL">IL</option>
                            <option value="Indiana - IN">IN</option>
                            <option value="Iowa - IA">IA</option>
                            <option value="Kansas - KS">KS</option>
                            <option value="Kentucky - KY">KY</option>
                            <option value="Louisiana - LA">LA</option>
                            <option value="Maine - ME">ME</option>
                            <option value="Maryland - MD">MD</option>
                            <option value="Massachusetts - MA">MA</option>
                            <option value="Michigan - MI">MI</option>
                            <option value="Minnesota - MN">MN</option>
                            <option value="Mississippi - MS">MS</option>
                            <option value="Missouri - MO">MO</option>
                            <option value="Montana - MT">MT</option>
                            <option value="Nebraska - NE">NE</option>
                            <option value="Nevada - NV">NV</option>
                            <option value="New Hampshire - NH">NH</option>
                            <option value="New Jersey - NJ">NJ</option>
                            <option value="New Mexico - NM">NM</option>
                            <option value="New York - NY">NY</option>
                            <option value="North Carolina - NC">NC</option>
                            <option value="North Dakota - ND">ND</option>
                            <option value="Ohio - OH">OH</option>
                            <option value="Oklahoma - OK">OK</option>
                            <option value="Oregon - OR">OR</option>
                            <option value="Pennsylvania - PA">PA</option>
                            <option value="Rhode Island - RI">RI</option>
                            <option value="South Carolina - SC">SC</option>
                            <option value="South Dakota - SD">SD</option>
                            <option value="Tennessee - TN">TN</option>
                            <option value="Texas - TX">TX</option>
                            <option value="Utah - UT">UT</option>
                            <option value="Vermont - VT">VT</option>
                            <option value="Virginia - VA">VA</option>
                            <option value="Washington - WA">WA</option>
                            <option value="West Virginia - WV">WV</option>
                            <option value="Wisconsin - WI">WI</option>
                            <option value="Wyoming - WY">WY</option>
                        </datalist>
                    </div>
                    
                    <!-- Event Type -->
                    <div class="col-md-3">
                        <label for="eventTypeFilter" class="form-label">Event Type</label>
                        <select class="form-select" id="eventTypeFilter">
                            <option value="">All Events</option>
                            <option value="Severe Thunderstorm Warning">Severe Thunderstorm Warning</option>
                            <option value="Tornado Warning">Tornado Warning</option>
                            <option value="Tornado Watch">Tornado Watch</option>
                            <option value="Severe Thunderstorm Watch">Severe Thunderstorm Watch</option>
                            <option value="Severe Weather Statement">Severe Weather Statement</option>
                        </select>
                    </div>
                </div>
                
                <div class="row g-3 mt-1">
                    <!-- Minimum Hail Size -->
                    <div class="col-md-3">
                        <label for="minHailSize" class="form-label">Minimum Hail Size</label>
                        <select class="form-select" id="minHailSize">
                            <option value="">All Sizes</option>
                            <option value="0.25">0.25" (Pea)</option>
                            <option value="0.5">0.5" (Peanut/Marble)</option>
                            <option value="0.75">0.75" (Penny)</option>
                            <option value="0.88">0.88" (Nickel)</option>
                            <option value="1.0">1.0" (Quarter)</option>
                            <option value="1.25">1.25" (Half Dollar)</option>
                            <option value="1.5">1.5" (Ping Pong Ball)</option>
                            <option value="1.75">1.75" (Golf Ball)</option>
                            <option value="2.0">2.0" (Egg)</option>
                            <option value="2.5">2.5" (Tennis Ball)</option>
                            <option value="2.75">2.75" (Baseball)</option>
                            <option value="3.0">3.0" (Large Apple)</option>
                            <option value="4.0">4.0" (Softball)</option>
                            <option value="4.5">4.5"+ (Grapefruit/Record)</option>
                        </select>
                    </div>
                    
                    <!-- Minimum Wind Speed -->
                    <div class="col-md-3">
                        <label for="minWindSpeed" class="form-label">Minimum Wind Speed</label>
                        <select class="form-select" id="minWindSpeed">
                            <option value="">All Speeds</option>
                            <option value="50">50+ mph</option>
                            <option value="60">60+ mph</option>
                            <option value="70">70+ mph</option>
                            <option value="80">80+ mph</option>
                            <option value="90">90+ mph</option>
                            <option value="100">100+ mph</option>
                        </select>
                    </div>
                    
                    <!-- Start Date -->
                    <div class="col-md-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" value="2025-06-02">
                    </div>
                    
                    <!-- End Date -->
                    <div class="col-md-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" value="2025-06-07">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>Search & Filter
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Direct Radar Events Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-radar-dish me-1"></i>
                    Radar-Detected Severe Weather Events
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="directRadarTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Time</th>
                                <th>Event Type</th>
                                <th>Location</th>
                                <th>State</th>
                                <th>Hail Size</th>
                                <th>Wind Speed</th>
                                <th>Severity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="directRadarTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">Loading radar-detected events...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-hail-alerts">0</h4>
                        <p class="card-text">Hail Alerts</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-cloud-hail fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-wind-alerts">0</h4>
                        <p class="card-text">Wind Alerts</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-wind fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="max-hail-size">0.0"</h4>
                        <p class="card-text">Max Hail Size</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-ruler fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="max-wind-speed">0 mph</h4>
                        <p class="card-text">Max Wind Speed</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tachometer-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Pagination -->
<div class="row mt-3">
    <div class="col-12">
        <nav id="paginationContainer" style="display: none;">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be dynamically generated -->
            </ul>
        </nav>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};

document.addEventListener('DOMContentLoaded', function() {
    loadRadarAlerts();
});

function loadRadarAlerts(page = 1) {
    currentPage = page;
    
    // Build query parameters
    const params = new URLSearchParams({
        page: page,
        limit: 25
    });
    
    // Add filters
    Object.entries(currentFilters).forEach(([key, value]) => {
        if (value) params.append(key, value);
    });
    
    // Show loading state
    document.getElementById('directRadarTableBody').innerHTML = 
        '<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 mb-0 text-muted">Loading radar-detected alerts...</p></td></tr>';
    
    fetch(`/api/radar-alerts/direct?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            updateStatistics(data.alerts || []);
            updateAlertsTable(data.alerts || []);
            updatePagination(data);
        })
        .catch(error => {
            console.error('Error loading alerts:', error);
            document.getElementById('directRadarTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger py-4">Error loading alerts. Please try again.</td></tr>';
        });
}

function updateStatistics(alerts) {
    let hailAlerts = 0;
    let windAlerts = 0;
    let maxHail = 0;
    let maxWind = 0;
    
    alerts.forEach(alert => {
        if (alert.radar_indicated) {
            if (alert.radar_indicated.hail_inches > 0) {
                hailAlerts++;
                maxHail = Math.max(maxHail, alert.radar_indicated.hail_inches);
            }
            if (alert.radar_indicated.wind_mph > 0) {
                windAlerts++;
                maxWind = Math.max(maxWind, alert.radar_indicated.wind_mph);
            }
        }
    });
    
    document.getElementById('total-hail-alerts').textContent = hailAlerts;
    document.getElementById('total-wind-alerts').textContent = windAlerts;
    document.getElementById('max-hail-size').textContent = maxHail.toFixed(2) + '"';
    document.getElementById('max-wind-speed').textContent = maxWind + ' mph';
}

function updateAlertsTable(alerts) {
    const tbody = document.getElementById('directRadarTableBody');
    
    if (alerts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No radar-detected alerts found for the current filters.</td></tr>';
        return;
    }
    
    tbody.innerHTML = alerts.map(alert => {
        const radarData = alert.radar_indicated || {};
        const hailSize = radarData.hail_inches || 0;
        const windSpeed = radarData.wind_mph || 0;
        
        const hailDisplay = hailSize > 0 ? 
            `<span class="badge bg-danger">${hailSize.toFixed(2)}"</span><br><small>${getHailDescription(hailSize)}</small>` :
            '<span class="text-muted">-</span>';
            
        const windDisplay = windSpeed > 0 ? 
            `<span class="badge bg-warning text-dark">${windSpeed} mph</span><br><small>${getWindDescription(windSpeed)}</small>` :
            '<span class="text-muted">-</span>';
        
        const severityBadge = getSeverityBadge(hailSize, windSpeed);
        const effectiveTime = new Date(alert.effective).toLocaleString();
        
        return `
            <tr class="clickable-row" onclick="window.location.href='/alerts/${alert.id}'" style="cursor: pointer;">
                <td>
                    <div>${effectiveTime}</div>
                    <small class="text-muted">${alert.id.substring(0, 8)}...</small>
                </td>
                <td>
                    <span class="badge bg-secondary">${alert.event}</span>
                </td>
                <td>
                    ${formatLocationInfo(alert)}
                </td>
                <td>
                    ${formatStateInfo(alert)}
                </td>
                <td>${hailDisplay}</td>
                <td>${windDisplay}</td>
                <td>${severityBadge}</td>
                <td>
                    <a href="/alerts/${alert.id}" class="btn btn-sm btn-outline-primary" title="View Details" onclick="event.stopPropagation();">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            </tr>
        `;
    }).join('');
}

// Add hover effects for clickable rows
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .clickable-row:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
        }
        .clickable-row {
            transition: all 0.2s ease-in-out;
        }
    `;
    document.head.appendChild(style);
});

function formatLocationInfo(alert) {
    const parts = [];
    
    // Extract cities from city_names array
    if (alert.city_names && Array.isArray(alert.city_names) && alert.city_names.length > 0) {
        const cities = alert.city_names.slice(0, 3); // Show first 3 cities
        parts.push(cities.join(', '));
        if (alert.city_names.length > 3) {
            parts.push(`+${alert.city_names.length - 3} more`);
        }
        return parts.join(' ');
    }
    
    // Fallback to county names if no cities
    if (alert.county_names) {
        let counties = [];
        
        // Handle county_names as an object with state keys
        if (typeof alert.county_names === 'object' && !Array.isArray(alert.county_names)) {
            for (const [state, countyList] of Object.entries(alert.county_names)) {
                if (Array.isArray(countyList)) {
                    counties = counties.concat(countyList);
                }
            }
        } else if (Array.isArray(alert.county_names)) {
            counties = alert.county_names;
        }
        
        if (counties.length > 0) {
            const displayCounties = counties.slice(0, 3);
            parts.push(displayCounties.join(', '));
            if (counties.length > 3) {
                parts.push(`+${counties.length - 3} more`);
            }
            return parts.join(' ');
        }
    }
    
    // Final fallback to area description
    if (alert.areaDesc) {
        const shortArea = alert.areaDesc.length > 50 ? 
            alert.areaDesc.substring(0, 50) + '...' : alert.areaDesc;
        return shortArea;
    }
    
    return 'Location data unavailable';
}

function formatStateInfo(alert) {
    // Try to get states from affected_states first
    if (alert.affected_states && Array.isArray(alert.affected_states) && alert.affected_states.length > 0) {
        return alert.affected_states.join(', ');
    }
    
    // Fallback to extracting states from county_names object keys
    if (alert.county_names && typeof alert.county_names === 'object' && !Array.isArray(alert.county_names)) {
        const states = Object.keys(alert.county_names);
        if (states.length > 0) {
            return states.join(', ');
        }
    }
    
    // Final fallback to geocode UGC parsing
    if (alert.geocode && alert.geocode.UGC && Array.isArray(alert.geocode.UGC)) {
        const states = new Set();
        alert.geocode.UGC.forEach(ugc => {
            if (ugc.includes('C')) {
                const parts = ugc.split('C');
                if (parts.length === 2) {
                    states.add(parts[0]);
                }
            }
        });
        if (states.size > 0) {
            return Array.from(states).join(', ');
        }
    }
    
    return 'N/A';
}

function getHailDescription(size) {
    // Use centralized NWS hail size chart
    if (size >= 4.5) return 'Grapefruit (Record)';
    if (size >= 4.0) return 'Softball';
    if (size >= 3.0) return 'Large Apple';
    if (size >= 2.75) return 'Baseball';
    if (size >= 2.5) return 'Tennis Ball';
    if (size >= 2.0) return 'Egg';
    if (size >= 1.75) return 'Golf Ball';
    if (size >= 1.5) return 'Ping Pong Ball';
    if (size >= 1.25) return 'Half Dollar';
    if (size >= 1.0) return 'Quarter';
    if (size >= 0.88) return 'Nickel';
    if (size >= 0.75) return 'Penny';
    if (size >= 0.5) return 'Peanut';
    if (size >= 0.25) return 'Pea';
    return 'Small';
}

function getWindDescription(speed) {
    if (speed >= 90) return 'Tornado-level';
    if (speed >= 80) return 'Extreme';
    if (speed >= 70) return 'Significant';
    if (speed >= 58) return 'Severe Criteria';
    return 'Strong';
}

function getSeverityBadge(hailSize, windSpeed) {
    // Use centralized severity logic matching Config.get_hail_severity
    let severity = 'minor';
    let label = 'Minor';
    
    if (hailSize >= 4.0) {
        severity = 'extreme';
        label = 'Extremely Severe';
    } else if (hailSize >= 3.0) {
        severity = 'severe';
        label = 'Very Severe';
    } else if (hailSize >= 2.0) {
        severity = 'severe';
        label = 'Severe';
    } else if (hailSize >= 1.0) {
        severity = 'moderate';
        label = 'Significant';
    } else if (hailSize >= 0.5) {
        severity = 'minor';
        label = 'Notable';
    } else if (windSpeed >= 90) {
        severity = 'extreme';
        label = 'Extreme Wind';
    } else if (windSpeed >= 80) {
        severity = 'severe';
        label = 'High Wind';
    } else if (windSpeed >= 70) {
        severity = 'moderate';
        label = 'Strong Wind';
    }
    
    const badgeClass = severity === 'extreme' ? 'bg-danger' : 
                      severity === 'severe' ? 'bg-warning text-dark' : 
                      severity === 'moderate' ? 'bg-info' : 'bg-secondary';
    
    return `<span class="badge ${badgeClass}">${label}</span>`;
}

function updatePagination(data) {
    const container = document.getElementById('paginationContainer');
    const pagination = document.getElementById('pagination');
    
    if (data.pages <= 1) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadRadarAlerts(${currentPage - 1}); return false;">Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= Math.min(data.pages, 10); i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadRadarAlerts(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${currentPage === data.pages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadRadarAlerts(${currentPage + 1}); return false;">Next</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Direct radar alerts variables
let directCurrentPage = 1;
let directTotalPages = 1;

async function loadDirectRadarAlerts(page = 1) {
    try {
        directCurrentPage = page;
        
        const params = new URLSearchParams({
            page: page,
            limit: 25,
            ...currentFilters
        });
        
        const response = await fetch(`/api/radar-alerts/direct?${params.toString()}`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        directTotalPages = data.pages;
        updateDirectRadarTable(data.alerts);
        updateDirectPagination();
        
    } catch (error) {
        console.error('Error loading direct radar alerts:', error);
        document.getElementById('directRadarTableBody').innerHTML = 
            '<tr><td colspan="8" class="text-center py-4 text-danger">Error loading radar alerts: ' + error.message + '</td></tr>';
    }
}

function updateDirectRadarTable(alerts) {
    const tbody = document.getElementById('directRadarTableBody');
    
    if (alerts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No radar-detected alerts found for the current filters.</td></tr>';
        return;
    }
    
    tbody.innerHTML = alerts.map(alert => {
        const radarData = alert.radar_indicated || {};
        const hailSize = radarData.hail_inches || 0;
        const windSpeed = radarData.wind_mph || 0;
        
        const hailDisplay = hailSize > 0 ? 
            `<span class="badge bg-danger">${parseFloat(hailSize).toFixed(2)}"</span>` :
            '<span class="text-muted">-</span>';
            
        const windDisplay = windSpeed > 0 ? 
            `<span class="badge bg-warning text-dark">${parseInt(windSpeed)} mph</span>` :
            '<span class="text-muted">-</span>';
        
        const severityBadge = getSeverityBadge(hailSize, windSpeed);
        const effectiveTime = new Date(alert.effective).toLocaleString();
        
        return `
            <tr class="clickable-row" onclick="window.location.href='/alerts/${alert.id}'" style="cursor: pointer;">
                <td>
                    <div>${effectiveTime}</div>
                    <small class="text-muted">${alert.id.substring(0, 8)}...</small>
                </td>
                <td>
                    <span class="badge bg-secondary">${alert.event}</span>
                </td>
                <td>
                    ${formatLocationInfo(alert)}
                </td>
                <td>
                    ${formatStateInfo(alert)}
                </td>
                <td>${hailDisplay}</td>
                <td>${windDisplay}</td>
                <td>${severityBadge}</td>
                <td>
                    <a href="/alerts/${alert.id}" class="btn btn-sm btn-outline-primary" title="View Details" onclick="event.stopPropagation();">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            </tr>
        `;
    }).join('');
}

function updateDirectPagination() {
    // Add pagination controls for direct table if needed
    // For now, we'll keep it simple and just load the first page
}

function applyFilters() {
    currentFilters = {};
    
    // Get elements with null checks
    const searchEl = document.getElementById('searchFilter');
    const stateEl = document.getElementById('stateFilter');
    const eventTypeEl = document.getElementById('eventTypeFilter');
    const minHailEl = document.getElementById('minHailSize');
    const minWindEl = document.getElementById('minWindSpeed');
    const startDateEl = document.getElementById('startDate');
    const endDateEl = document.getElementById('endDate');
    
    // Apply new filters with null safety
    if (searchEl && searchEl.value) currentFilters.q = searchEl.value;
    if (stateEl && stateEl.value) currentFilters.state = stateEl.value;
    if (eventTypeEl && eventTypeEl.value) currentFilters.event = eventTypeEl.value;
    if (minHailEl && minHailEl.value) currentFilters.min_hail = parseFloat(minHailEl.value);
    if (minWindEl && minWindEl.value) currentFilters.min_wind = parseInt(minWindEl.value);
    if (startDateEl && startDateEl.value) currentFilters.start_date = startDateEl.value;
    if (endDateEl && endDateEl.value) currentFilters.end_date = endDateEl.value;
    
    loadRadarAlerts(1);
}

function clearFilters() {
    // Clear elements with null safety
    const searchEl = document.getElementById('searchFilter');
    const stateEl = document.getElementById('stateFilter');
    const eventTypeEl = document.getElementById('eventTypeFilter');
    const minHailEl = document.getElementById('minHailSize');
    const minWindEl = document.getElementById('minWindSpeed');
    const startDateEl = document.getElementById('startDate');
    const endDateEl = document.getElementById('endDate');
    
    if (searchEl) searchEl.value = '';
    if (stateEl) stateEl.value = '';
    if (eventTypeEl) eventTypeEl.value = '';
    if (minHailEl) minHailEl.value = '';
    if (minWindEl) minWindEl.value = '';
    if (startDateEl) startDateEl.value = '2025-06-02';
    if (endDateEl) endDateEl.value = '2025-06-07';
    
    currentFilters = {};
    loadRadarAlerts(1);
}

function refreshAlerts() {
    loadRadarAlerts(currentPage);
}

function exportData() {
    const params = new URLSearchParams({
        has_radar_data: 'true',
        limit: 1000,
        format: 'csv'
    });
    
    Object.entries(currentFilters).forEach(([key, value]) => {
        if (value) params.append(key, value);
    });
    
    window.open(`/alerts/search?${params.toString()}`, '_blank');
}

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Set default date range
    document.getElementById('startDate').value = '2025-06-02';
    document.getElementById('endDate').value = '2025-06-07';
    
    // Load radar alerts table
    loadRadarAlerts(1);
});
</script>
{% endblock %}